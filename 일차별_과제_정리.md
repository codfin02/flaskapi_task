# FastAPI 과제 일차별 정리

## **1일차: FastAPI 기본 구조 및 API 작성**

### **완성된 내용**
**프로젝트 구조 설정**
```
fastapi_assignment/
│── app/
│   ├── models/          # 사용자 및 영화 모델
│   ├── schemas/         # Pydantic 스키마
│   ├── tests/           # 테스트 코드
│   └── __init__.py
├── main.py              # FastAPI 앱
├── pyproject.toml       # Poetry 설정
└── README.md            # 프로젝트 설명
```

**Pydantic 스키마 정의**
```python
class UserCreateRequest(BaseModel):
    username: str
    age: int
    gender: GenderEnum

class UserUpdateRequest(BaseModel):
    username: Optional[str] = None
    age: Optional[int] = None

class UserResponse(BaseModel):
    id: int
    username: str
    age: int
    gender: GenderEnum

class UserSearchParams(BaseModel):
    model_config = {"extra": "forbid"}
    username: Optional[Annotated[int, conint(gt=0)]] = None
    gender: Optional[GenderEnum] = None
```

**사용자 모델 구현**
```python
class UserModel:
    _data: ClassVar[List["UserModel"]] = []
    _id_counter: ClassVar[int] = 1
    
    @classmethod
    def create(cls, username: str, age: int, gender: str) -> "UserModel":
        return cls(username, age, gender)
```

**API 엔드포인트 구현**
- POST `/users` - 사용자 생성
- GET `/users` - 모든 사용자 조회
- GET `/users/{user_id}` - 특정 사용자 조회
- PATCH `/users/{user_id}` - 사용자 정보 수정
- DELETE `/users/{user_id}` - 사용자 삭제
- GET `/users/search` - 사용자 검색

**TDD 방식 테스트 코드**
- 11개 테스트 모두 통과
- 코드 커버리지 99% 달성
- 각 API 엔드포인트별 테스트 케이스

**코드 품질 관리 도구**
- Black (코드 포맷팅)
- Ruff (린팅)
- MyPy (타입 검증)
- Coverage (테스트 커버리지)

**통합 실행 스크립트**
```bash
./test.sh  # 모든 도구를 순차적으로 실행
```

---

## **2일차: 영화 관리 API 구현**

### **완성된 내용**
**영화 모델 구현**
```python
class MovieModel:
    _data: ClassVar[List["MovieModel"]] = []
    _id_counter: ClassVar[int] = 1

    def __init__(self, title: str, playtime: int, genre: List[str]) -> None:
        self.id = MovieModel._id_counter
        self.title: str = title
        self.playtime: int = playtime
        self.genre: List[str] = genre
        MovieModel._data.append(self)
        MovieModel._id_counter += 1

    @classmethod
    def create(cls, title: str, playtime: int, genre: List[str]) -> "MovieModel":
        return cls(title, playtime, genre)

    @classmethod
    def filter(cls, **kwargs: Union[str, int]) -> List["MovieModel"]:
        result = [
            movie for movie in cls._data
            if all(getattr(movie, key) == value or value in getattr(movie, key) 
                   for key, value in kwargs.items())
        ]
        return result
```

**영화 스키마 정의**
```python
class CreateMovieRequest(BaseModel):
    title: str
    playtime: int
    genre: List[str]

class MovieUpdateRequest(BaseModel):
    title: Optional[str] = None
    playtime: Optional[Annotated[int, Field(gt=0)]] = None
    genre: Optional[List[str]] = None

class MovieResponse(BaseModel):
    id: int
    title: str
    playtime: int
    genre: List[str]

class MovieSearchParams(BaseModel):
    title: Optional[str] = None
    genre: Optional[str] = None
```

**영화 API 엔드포인트**
- POST `/movies` - 영화 등록 (201 상태코드)
- GET `/movies` - 전체 영화 조회 및 검색 (200 상태코드)
- GET `/movies/{movie_id}` - 특정 영화 조회 (200 상태코드)
- PATCH `/movies/{movie_id}` - 영화 정보 수정 (200 상태코드)
- DELETE `/movies/{movie_id}` - 영화 삭제 (204 상태코드)

**고급 기능 구현**
- **Field(gt=0)**를 사용한 playtime 검증
- **상태 코드** 적절히 활용 (201, 200, 204)
- **쿼리 매개변수** 검색 기능 (제목, 장르)
- **타입 안전성** 완벽하게 구현

**테스트 코드**
- 10개 영화 API 테스트 모두 통과
- 전체 테스트 21개 통과
- **테스트 커버리지 100%** 달성

### **주요 특징**
- **Pydantic 모델**을 활용한 데이터 검증
- **타입 힌트** 완벽하게 적용
- **TDD 방식**으로 개발 진행
- **코드 품질** 검사 통과 (black, ruff, mypy)

---

## **3일차: 고급 FastAPI 기능 구현**

### **완성된 내용**
**프로젝트 구조 확장**
```
fastapi_assignment/
│── app/
│   ├── models/          # 사용자 및 영화 모델
│   ├── schemas/         # Pydantic 스키마
│   ├── services/        # 비즈니스 로직 서비스
│   ├── middleware/      # 인증 미들웨어
│   ├── routers/         # API 라우터 모듈화
│   ├── tests/           # 테스트 코드
│   └── __init__.py
├── main.py              # FastAPI 앱 (라우터 통합)
├── pyproject.toml       # Poetry 설정
└── README.md            # 프로젝트 설명
```

**사용자 모델 보안 강화**
- `password` 필드 추가 및 bcrypt 해싱
- `authenticate()` 메서드로 로그인 검증
- `verify_password()` 정적 메서드로 비밀번호 확인

**JWT 서비스 구현**
- 액세스 토큰(5분) 및 리프레시 토큰(24시간) 생성
- 쿠키 기반 토큰 전송 및 관리
- 토큰 인코딩/디코딩 및 만료 시간 처리

**인증 서비스 구현**
- 사용자 로그인 및 JWT 토큰 발급
- 현재 인증된 사용자 조회 (`request.state.user`)
- HTTP 상태 코드 401로 인증 실패 처리

**인증 미들웨어 구현**
- `/users` 경로 자동 인증 처리
- 공개 경로 제외: `/users/login`, `/users`, `/users/search`
- 예외 처리 및 적절한 HTTP 응답 반환

**API 라우터 모듈화**
- `user_router`와 `movie_router`로 엔드포인트 분리
- `APIRouter`를 사용한 태그별 그룹화
- 메인 앱에서 `include_router()`로 통합

**새로운 API 엔드포인트**
- POST `/users/login` - 사용자 로그인 및 JWT 토큰 발급
- GET `/users/me` - 현재 인증된 사용자 정보 조회
- PATCH `/users/me` - 현재 인증된 사용자 정보 수정
- DELETE `/users/me` - 현재 인증된 사용자 삭제

**보안 기능**
- **비밀번호 해싱**: bcrypt를 사용한 안전한 비밀번호 저장
- **JWT 토큰**: 액세스 토큰(5분) 및 리프레시 토큰(24시간)
- **쿠키 기반 인증**: HTTP 쿠키를 통한 토큰 전송
- **자동화된 인증**: 미들웨어를 통한 경로별 자동 인증 처리

**의존성 관리**
- `passlib[bcrypt]` - 비밀번호 해싱
- `PyJWT` - JWT 토큰 생성 및 검증
- `python-multipart` - 폼 데이터 처리

### **주요 특징**
- **모듈화된 구조**: 서비스, 미들웨어, 라우터로 코드 분리
- **보안 강화**: 비밀번호 해싱 및 JWT 기반 인증
- **자동화된 인증**: 미들웨어를 통한 경로별 자동 인증
- **의존성 주입**: FastAPI의 Depends를 활용한 서비스 주입
- **타입 안전성**: 완벽한 타입 힌트 및 검증

---

## **4일차: 데이터베이스 연동 및 ORM 구현**

### **완성된 내용**
**프로젝트 구조 확장**
```
fastapi_assignment/
│── app/
│   ├── models/          # Tortoise ORM 모델
│   ├── schemas/         # Pydantic 스키마
│   ├── services/        # 비즈니스 로직 서비스
│   ├── middleware/      # 인증 미들웨어
│   ├── routers/         # API 라우터 모듈화
│   ├── configs/         # 설정 관리
│   ├── tests/           # 테스트 코드
│   └── __init__.py
├── .env                 # 환경변수 파일
├── main.py              # FastAPI 앱 (Tortoise ORM 통합)
├── pyproject.toml       # Poetry 설정
└── README.md            # 프로젝트 설명
```

**환경변수 관리**
- `.env` 파일로 MySQL 연결 정보 관리
- `pydantic-settings`를 활용한 설정 클래스
- SECRET_KEY, JWT 설정, 데이터베이스 설정 통합 관리

**데이터베이스 연동**
- `tortoise-orm[asyncmy]`를 사용한 MySQL 연동
- 비동기 데이터베이스 연결 및 풀링
- 한국 시간대 설정 (Asia/Seoul)

**새로운 데이터베이스 모델**
- `BaseModel`: 공통 필드 (id, created_at)
- `User`: 사용자 정보 및 인증 데이터
- `Movie`: 영화 정보 및 출연진 JSON 데이터

**서비스 레이어 개선**
- JWT 서비스: 환경변수 기반 설정
- Auth 서비스: 비밀번호 해싱, 인증 로직
- Tortoise ORM을 활용한 비동기 데이터베이스 작업

**API 라우터 수정**
- 새로운 모델에 맞게 모든 엔드포인트 수정
- 비동기 데이터베이스 작업 지원
- JSON 필드 및 Enum 필드 활용

**테스트 환경 구축**
- `tortoise.contrib.test` 사용
- MySQL 테스트 데이터베이스 설정
- TestCase 클래스 기반 테스트 구조

**CI/CD 파이프라인**
- MySQL 데이터베이스 셋업 포함
- 정적 분석과 테스트 병렬 실행
- 데이터베이스 마이그레이션 지원

### **주요 특징**
- **데이터베이스 연동**: MySQL과 Tortoise ORM 통합
- **비동기 처리**: 모든 데이터베이스 작업 비동기화
- **환경변수 관리**: 설정의 중앙화 및 보안 강화
- **ORM 활용**: 데이터베이스 모델과 API 완벽 연동
- **테스트 환경**: 실제 데이터베이스를 사용한 통합 테스트 